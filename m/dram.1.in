.\" vim: tw=72 fdm=marker cms=.\\"\ %s
.
.\" FRONT MATTER {{{
.Dd December 13, 2022
.Dt DRAM 1
.Os
.
.Sh NAME
.Nm dram
.Nd literate functional tests for the CLI
.\" FRONT MATTER }}}
.
.\" SYNOPSIS {{{
.Sh SYNOPSIS
.Nm
. Fl h | V
.Nm
. Op Fl DETUfiuv
. Op Fl I Ar INDENT
. Oo Fl e Ar VAR Ns Oo Li = Ns Ar VAL Oc Oc Ns ...
. Op Fl s Ar SHELL
. Op Fl t Ar SUFFIX
. Ar TEST...
.\" SYNOPSIS }}}
.
.\" DESCRIPTION {{{
.Sh DESCRIPTION
.Nm
is a tool for functional tests of CLI applications.
.Pp
.Nm
extracts all commands from a testfile into a script,
runs the script with a modified environment, in an empty
directory, with standard input redirected from
.Pa /dev/null ,
and standard output plus standard error redirected into
a file.
Individual commands are fenced from each other
so their outputs are unambiguously attributable.
.Pp
.Nm
then compares the actual outputs with expected ones,
and offers their differences (as unified diffs) for merging
into the original testfiles.
.\" }}}
.
.\" OPTIONS {{{
.Sh OPTIONS
.Bl -tag -width xx
. It Fl h
Display usage information.
. It Fl V
Display version information.
. It Fl D
Do not print diffs.
. It Fl E
Preserve existing environment variables.
. It Fl I Ar INDENT
Number of spaces used for test code indentation
. Pq default: Li 2 .
. It Fl T
Leave behind working files.
. It Fl U
Do not merge actual output into tests.
Overrides preceding
. Fl i
and
. Fl u .
. It Fl e Ar VAR Ns Op Li = Ns Ar VAL
Run tests with
. Ev VAR
set to
. Ar VAL
in environment.
In the
. Fl e Ar VAR
form,
. Ev VAR
is copied from
. Nm Ns 's
environment.
. It Fl f
Abort after first failed test.
Skip any remaining tests.
. It Fl i
Interactively merge actual output into tests.
Overrides preceding
. Fl U
and
. Fl u .
. It Fl s Ar SHELL
Shell to use for running tests
. Pq default: Li sh .
. It Fl t Ar SUFFIX
Extension of testfiles
. Pq default: Li .t .
. It Fl u
Merge actual output into tests.
Overrides preceding
. Fl U
and
. Fl i .
. It Fl v
Show filenames with test statuses.
.El
.\" }}}
.
.\" ENVIRONMENT {{{
.Sh ENVIRONMENT
.Ss Variables used by Nm
.
Options take precedence over corresponding environment variables.
.
.Bl -tag -width xx
. It Ev DRAM_DIFF
Program used to generate diffs.
Defaults to
. Pa diff .
. It Ev DRAM_ENV
Whitespace-separated list of environment variables to copy from
.Nm Ns 's
environment into the environment of each test.
. It Ev DRAM_FAIL_FAST
If set to any of
. Qq Li 1Yy ,
enables
. Fl f .
. It Ev DRAM_INDENT
String used to indent command, continuation, output, and
exit code lines.
. It Ev DRAM_KEEP_ENVIRON
If set to any of
. Qo Li 1Yy Qc , enables Fl E .
. It Ev DRAM_KEEP_TMPDIR
If set to any of
. Qo Li 1Yy Qc , enables Fl T .
. It Ev DRAM_NODIFFS
If set to any of
. Qo Li 1Yy Qc , enables Fl D .
. It Ev DRAM_PATCH
Program used to apply diffs.
Defaults to
. Pa patch .
. It Ev DRAM_SHELL
See Fl s .
. It Ev DRAM_UPDATE
If set to any of
. Qo Li Aa Qc , enables Fl i .
If set to any of
. Qo Li 1Yy Qc , enables Fl u .
If unset or set to any other value, enables
. Fl U .
. It Ev DRAM_TEST_SUFFIX
See Fl t .
. It Ev DRAM_TMPDIR
If set,
. Nm
will create working files in this directory
instead of creating one under
. Ev TMPDIR .
. It Ev DRAM_VERBOSE
If set to any of
. Qo Li 1Yy Qc , enables Fl v .
.El
.Pp
Beside the above,
.Nm
may be influenced by environment variables used by
.Xr diff 1 ,
.Xr patch 1 ,
.Xr sh 1 ,
possibly others.
.
.Ss Environment of test scripts
.
.Nm
runs tests with environment limited to the following
variables and values by default.
This behavior can be inhibited by
.Fl E
or
.Ev DRAM_KEEP_ENVIRON , and augmented using
.Fl e Ar VAR Ns Op Li = Ns Ar VAL
and/or
.Ev DRAM_ENV .
Environment variables with names starting with
.Qq Li DRAM_
are
.Em always
removed from the environment of tests.
.
.Bl -tag -width xx
. It Ev COLUMNS Ns Li = Ns Qq Li 80
. It Ev LANG Ns Li = Ns Qq Li C
. It Ev LC_ALL Ns Li = Ns Qq Li C
. It Ev LINES Ns Li = Ns Qq Li 20
. It Ev PATH Ns Li = Ns Qq Li /usr/local/bin:/usr/local/sbin:/bin:/sbin:/usr/bin:/usr/sbin .
Inherited from
. Nm Ns No 's environment if present .
. It Ev TESTDIR
Absolute path of the directory containing the testfile.
. It Ev TESTFILE
Basename of the testfile.
. It Ev TMPDIR
Pathname of an existing, writable, empty directory.
. It Ev TZ Li UTC
.El
.\" }}}
.
.\" EXIT STATUS {{{
.Sh EXIT STATUS
.Bl -tag -width xx
.It 0
Success.
.It 1
Usage error.
.It 2
A test failed.
.It 4
A test was broken.
.It 8
External utility error.
.El
.\" }}}
.
.\" EXAMPLES {{{
.Sh EXAMPLES
.Bd -literal
$ dram t
s.!X
--- 3.t
+++ 3.t
@@ -1,2 +1,2 @@
   $ echo hello
-  goodbye
+  hello

# 3 tests, 1 skipped, 1 failed, 1 broken
$ echo $?
6
.Ed
.\" }}}
.
.\" SEE ALSO {{{
.Sh SEE ALSO
.Xr diff 1 ,
.Xr patch 1 ,
.Xr sh 1 ,
.Xr dram 5 ,
.Lk https://bitheap.org/cram .
.\" }}}
.
.\" AUTHORS {{{
.Sh AUTHORS
.An Roman Neuhauser Aq Mt rn+dram@sigpipe.cz
.\" AUTHORS }}}
.
.\" BUGS {{{
.Sh BUGS
No doubt plentiful.
Please report them at
.Lk https://todo.sr.ht/~rne/dram .
.\" BUGS }}}
